name: vivaldi
version: 6.7.3329.35-1
summary: Vivaldi Browser - Feature-packed web browser
description: |
    The web browser for techies and people who need a browser that helps them get things done.
    The user interface is fully customizable, including keyboard shortcuts, mouse gestures, and programmable macros.

    NOTE: This package is maintained by but not yet officially endorsed or supported by Vivaldi Technologies.
confinement: strict
grade: stable
base: core22

# TODO: source-code
# TODO: compression: lzo

# TODO: license
# TODO: publisher
# TODO: linter problems
# TODO: Test and fix:
#   * ffmpeg related stuff
#     - video playback
#     - update-ffmpeg binary
#     - browser startup download of the lib
#   * filesystem handling (downloads, etc)
#   * sandboxing
#   * cups/printing
#   * wayland/x11 - support both
#   * secure-storage related stuff
#     - handling of gnome-keyring
#   * policy patch? https://git.launchpad.net/~chromium-team/chromium-browser/+git/snap-from-source/tree/build/chromium-patches/snap-policies-path.patch
#   * search engines
#   * Failed to adjust OOM
#   * usb midi
#   * XDG open handling
#   * Sound
#   * DCONF

apps:
  vivaldi:
    extensions: [gnome]
    command: bin/vivaldi.launcher
    desktop: usr/share/applications/vivaldi.desktop
    plugs:
      - network-bind
      - audio-playback
      - audio-record
      - bluez # for Web Bluetooth (https://launchpad.net/bugs/1887201)
      - camera
      - cups
      - hardware-observe
      - home
      - joystick
      - mount-observe
      - network
      - network-manager
      - password-manager-service
      - raw-usb # for WebUSB (https://launchpad.net/bugs/1780678)
      - removable-media
      - screen-inhibit-control
      - system-packages-doc
      - u2f-devices
      - desktop
      - desktop-legacy
      - wayland
      - x11
      - upower-observe
      - opengl
      - shmem
      - browser-sandbox
    slots:
      - dbus-daemon

plugs:
  browser-sandbox:
    interface: browser-support
    allow-sandbox: true
  shmem:
    interface: shared-memory
    private: true
  chromium-ffmpeg-115016:
    interface: content
    target: $SNAP
    default-provider: chromium-ffmpeg

slots:
  dbus-daemon:
    interface: dbus
    bus: session
    name: com.vivaldi.vivaldi

parts:
  vivaldi:
    plugin: nil
    after:
      - launcher
    source: https://downloads.vivaldi.com/stable/vivaldi-stable_6.7.3329.35-1_amd64.deb
    source-checksum: sha512/aac408ba134dd97c691fc3382c24548ead6de1fe92541078c709eed3fc4b2d11b380eae50085119402a7c11388b42c7b5abee4fc4fdeda5fe6e408543527241a
    build-packages:
      - coreutils # for install command
      - sed
    stage-packages:
      - libsecret-1-0
      - libatk1.0-0
      - libatspi2.0-0
      - libcairo2
      - libcups2
      - libcurl3-gnutls
      - libdbus-1-3
      - libdrm2
      - libexpat1
      - libgbm1
      - libglib2.0-0
      - libgtk-3-0
      - libnspr4
      - libnss3
      - libpango-1.0-0
      - libu2f-udev
      - libvulkan1
      - libx11-6
      - libxcb1
      - libxcomposite1
      - libxdamage1
      - libxext6
      - libxfixes3
      - libxkbcommon0
      - libxrandr2
      - wget
      - xdg-utils
      - libasound2
      - libgl1
    override-build: |
      mkdir -p $CRAFT_PART_INSTALL/opt
      # install vivaldi data
      cp -r $CRAFT_PART_BUILD/opt/vivaldi $CRAFT_PART_INSTALL/opt

      # install desktop file
      mkdir -p $CRAFT_PART_INSTALL/usr/share/applications/
      install $CRAFT_PART_BUILD/usr/share/applications/vivaldi-stable.desktop $CRAFT_PART_INSTALL/usr/share/applications/vivaldi.desktop

      # deploy icons into the install dir
      for size in 16 24 32 48 64 128 256; do
          mkdir -p $CRAFT_PART_INSTALL/usr/share/icons/hicolor/${size}x${size}/
          install -Dm 644 $CRAFT_PART_BUILD/opt/vivaldi/product_logo_${size}.png $CRAFT_PART_INSTALL/usr/share/icons/hicolor/${size}x${size}/apps/vivaldi.png
      done
      # fix the rights on the sandbox file
      chmod 4755 $CRAFT_PART_INSTALL/opt/vivaldi/vivaldi-sandbox

      # icon path fixup
      sed -i 's|Icon=vivaldi|Icon=usr/share/icons/hicolor/256x256/apps/vivaldi.png|' $CRAFT_PART_INSTALL/usr/share/applications/vivaldi.desktop
      # we don't need update-ffmpeg (we're using chromium-ffmpeg plug)
      rm $CRAFT_PART_INSTALL/opt/vivaldi/update-ffmpeg

      # we're using vivaldi binary directly (this overwrites the shell wrapper)
      mv $CRAFT_PART_INSTALL/opt/vivaldi/vivaldi-bin $CRAFT_PART_INSTALL/opt/vivaldi/vivaldi

  launcher:
    plugin: dump
    source: launcher
    organize:
      '*': bin/
